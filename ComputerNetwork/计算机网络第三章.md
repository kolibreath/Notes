# 第三章 网络层
 
# 第三章
- 数据报虚电路源路由
- 学习型网校
- IP协议
- ARP协议
- 划分子网 构造超网
- ICMP
- RIP OSPF BGP
- IPv6 
- 移动IP

## 数据报和虚电路和源路由
- 数据报<br>
交换机需要保存端口号 和 目的主机 
![](https://upload-images.jianshu.io/upload_images/4714178-02782f7ed9bf7d47.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
建立转发表<br>
存在的问题：
控制流量，控制拥塞
- 什么是虚电路<br>
虚电路是分组交换传输方式中的一种，是分组交换服务提供的面向连接的通信服务，在两个节点和应用进程之间建立起一个逻辑上的虚电路后，两点之间就可以发送分组。
- 虚电路
VC表 <br>VCI 可以理解为路径的名称
VC表中的条目：<br>

|输入接口|输入VCI|输出接口|输出VCI|
|:--:|:-:|:--:|:--:|
|2|5|1|11

管理员会每段连路上选择一个当前没有使用的VCI，然后交换机选择需要输出的端口号。这样自动进行虚电路的j建立比较费时费力，通常管理员使用信令的方式主动建立。<br>
最后主机A可以通过发送撤销消息撤销这个虚电路

区分名词：永久虚电路/信令虚电路
> 问题：在这两种方法中，交换机如何知道输出的端口是什么？``路由算法 路由选择``

- 源路由
发送方A需要充分了解网络中的拓扑结构，而且首部中分组的大小是可变的，是不确定的
![UNADJUSTEDNONRAW_thumb_5.jpg](https://upload-images.jianshu.io/upload_images/4714178-17485e006b8ef95a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 网桥和交换机

- 学习型网桥
网桥：一个输入端口，一个输出端口，总是将输入端口上面的帧转移到输出端口上。
- 生成树算法
如何消灭在局域网中形成的环
生成算法 ：
![2E48E6D6D5DAABE3C8DA36A1423DC682.jpg](https://upload-images.jianshu.io/upload_images/4714178-46feab2f879507c5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 广播和多播
### VLAN
使用VLAN可以在逻辑上划分不同子网内的主机。
- VLAN的作用<br>
    - 限制广播域<br>广播域被限制在一个VLAN内，节省了带宽，提高了网络处理能力。

    - 增强局域网的安全性<br>不同VLAN内的报文在传输时是相互隔离的，即一个VLAN内的用户不能和其它VLAN内的用户直接通信。

    - 提高网络的健壮性<br>故障被限制在一个VLAN内，本VLAN内的故障不会影响其他VLAN的正常工作。

    - 灵活构建虚拟工作组<br>用VLAN可以划分不同的用户到不同的工作组，同一工作组的用户也不必局限于某一固定的物理范围，网络构建和维护更方便灵活。

# 《谢希仁》 第四章 网络层
- 和IP 协议配套使用的三个协议
    - 地址解析协议 ARP
    - 网际组管理协议IGMP
    - 网际控制报文协议 ICMP
    ![各种协议之间的关系](https://upload-images.jianshu.io/upload_images/4714178-39110ed5d3f8ac55.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- 虚拟互连网络
- VPN
- 网络地址转换NAT
- 多协议标记交换MPLS

## 网络层面向传输层应该提供的服务
- 面向连接
    - 虚电路（电信网络的设计思路）
- 无连接
    - 数据报 <br>
    > 网络层向上只提供简单灵活的 无连接的 近最大努力交付的数据报服务
    ![虚电路和数据报的比较](https://upload-images.jianshu.io/upload_images/4714178-a6f90bc19b50d41a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 虚拟互连网络
- 为什么需要虚拟互连网络<br>
网络的种类很多，不可能面面俱到的考虑到每个网络的 最大分组长度， 不同的接入机制，不同的超时控制，不同的差错回复方法，路由控制技术，用户接入控制等
- 四种网络互连终结设备
    - 转发器（物理层）
    - 网桥  （数据链路层）
    - 路由器（网络层）
    - 网关  （网络层即以上）
![互连网络](https://upload-images.jianshu.io/upload_images/4714178-ad55154f11a3b612.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
性能各异的网络再网络层上看起来像是一个统一的网络
## IP 网际协议
- 什么是网际协议<br>
物理网络的异构性本来就是客观存在的，但是我们可以使用IP协议是这些性能各异的网络在网络层看起来好像是一个统一的网络。
- 服务模型的两个组成部分
    - 编址方案
    - best-effort模型
### IP地址的分类
一般情况下：主机号后者网络号全0 或者全1都不可以计入。<br>
全0表示”this“
> 有下面几种类别

- A类
    - 127.0.0.1 
    表示环回测试<br>
    - 主机号全为1 表示这个网络上所有的主机  127.7.255.255
- B类<br>
网络号字段为两个字节，但是前面两位 1 0 已经固定了，后面14位不会出现全0或者全1，不需要-2<br>
但是 不指派 128.0.0.0 最小的地址是128.0.0.1 最大主机数是2^14 -1 
- C类
C类地址有三个字节地网络号字段，但是三位已经固定了，所以可指派的网络总数是2^21 - 1，除去 192.0.0.0 
![](https://upload-images.jianshu.io/upload_images/4714178-43f0e5fdb6b66b0f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### IP数据报格式
传输的封装格式
![从上层到下层传输封装格式](https://upload-images.jianshu.io/upload_images/4714178-e56ed1ea447b41fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### IP数据报的字段说明
![UNADJUSTEDNONRAW_thumb_6.jpg](https://upload-images.jianshu.io/upload_images/4714178-9ccfa099d444b931.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 重要字段说明
1. 版本 4<br>
IP协议的版本
2. 首部长度 4<br>
表示的最大可以包含的n个32位字（4字节）的个数，最大是15*4字节。如果是15的时候这个字段全。如果不是4字节的整数倍的话可以使用填充字段填充。
3. 区分服务 8 <br>
服务类型 是否获得更好的服务
4. 总长度 16
首部和数据之和的长度 <br>
如果长度超过数据链路层的最大容量MTU怎么办？<br>
``分片和重组``
根据不同的网络类型 会产生不同的MTU 最大传输单元。发送的时候d选择一个MTU，如果传递到小的MTU的网络再将这个数据报进行分片。分片之后可以在路由器上分片，在主机上进行重组。
5. 标识 16 <br>
相同的标志字段必须要重装成一个原来的数据报
6. 标志 3<br>
MF more fragment 还有分片 1 表示后面后面有分片<br>
DF dont fragment 不能分片 0 表示不能分片
7. 片偏移 13<br>
片偏移以八个字节为单位，分段长度一定是8的整数倍
比如1400 = 800 + 600 第二个分段的偏移量是100
8. 生存时间<br>
跳数限制
9. 协议<br>
指出数据报携带的是什么协议：
有ICMP IGMP TCP等
10. 首部检验和<br>
发送方求和取反码，接收方重复这个过程 然后检验结果是否相同。
11. 原地址
12. 目的地址


## ARP 协议
- ARP协议概述<br>
从网络层获得的IP地址解析出在数据链路层的硬件地址，但是
现在的DHCP协议已经包括了之前的RARP协议中的逆地址功能<br>
目前的主机中都包含ARP告诉缓存
- ARP协议工作过程
![ARP协议工作过程
](https://upload-images.jianshu.io/upload_images/4714178-05dba18421b607af.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- ARP协议只能工作在局域网中
- 工作在广播信道而不是点对点信道
- 为什么需要IP地址<br>
MAC地址可以代替IP地址吗？<br>不同的硬件地址和异构网络，这些异构网络通信需要进行硬件转换工作，IP编址解决这个问题。

## 路由选择
- 转发和路由
    - IP数据一定可以找到目的主机所在网络的路由器
    - 只有找到目的主机所在的网络 才进行直接交付
- 路由表中的表项
网络号 下一跳<br>
- 默认路由
减少路由表占用的空间和搜索路由表需要的时间

## IP协议和ARP协议共同完成数据转发
1. 发送者数据报中含有的内容是源IP和目的主机IP
2. 数据链路层的网络接口软件将路由表中的下一跳IP转换成MAC地址（ARP）

## 划分子网和构造超网
- 什么是划分子网
两级地址变成三级地址的过程：网络号：主机号：子网号，环节B类地址很快地好近的微机
- 划分子网的优点
    - 容易管理 可以灵活的增加新的主机
    - 路由表的表项不会很多
    - 减少空间浪费 IP重用
### 如何实现划分子网
- 划分子网
![划分子网](https://upload-images.jianshu.io/upload_images/4714178-de03275a47a49880.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- 子网掩码<br>
从目的主机IP转发到目的主机所在子网<br>
现代网络标准规定，所有的网络都必须使用子网掩码，所以路由表需要加上子网掩码这一项<br>
- 子网划分和无类地址<br>
矛盾：事实上C类地址可以分配255个主机，如果子网中的主机数目超过255就需要使用B类地址。<br>
使用物理地址的话将会浪费掉很多地址，解决方式就是子网划分，通过引入``子网掩码``划分子网地址，将输入不同物理网络中的主机共有相同的网络号。<br>
这样也需要修改路由表，<NetworkNum, NextHop> -> <SubNetSNum，SubnetMask，NextHop>
### 无分类编址 -- 构造超网
- 聚合超网的目的<br>
出现了划分子网的方法后从一定程度上解决了问题，但是B类地址还是即将耗尽，超网的目的就是为了聚合许多C类的网络。又被称作 -- CIDR
Classless Inter-Domain Routing
- 好处
    - 消除了A B C 三种类型的地址 增加了可以使用的网络的数目
    - 构成超网，减少了 路由表的数目
- 地址掩码<br>
地址掩码由一串的01和1组成，1的个数就是网络前缀的长度<br>

CIDR使用了``{<网络前缀>,<主机号>}``的方式，但是地址掩码和子网掩码有相似性，可以称地址掩码为子网掩码。

- DHCP服务器
dhcp服务器的出现是为了解决ip自动分配的问题。可以建立一个dhcp server，这个server会给子网掩码，默认网关等。<br>
分配的内容是一个租约，在一定的时间过去之后会重新需要续租。

## 网际控制报文协议 ICMP
- 报文格式
![ICMP 报文格式](https://upload-images.jianshu.io/upload_images/4714178-1cd5ce07f585f6a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- ICMP 报文的种类
    - ICMP 差错报告报文
        - 终点不可达 ：路由器或者主机不能交付数据报
        - 时间超过：路由器收到生存时间为0的报文 并且向源点发送时间超过报文；或者是在规定的时间内无法收到完整的数据报片段
        - 参数问题：IP数据报中有错误的内容
        - 改变路由：Redirect 寻找路径最短的最佳路由
    - ICMP 询问报文
        - 原站抑制报文
        - 地址掩码请求/应答报文
        - 回送请求和回答<br>
        给某个特定的主机发出的询问，用来测试目的站是否可达以及了解相关请求状态
        - 时间戳和请求和回答<br>
        时钟同步和时间测量

### ICMP的应用
- ping命令<br>
ping命令直接使用ICMP 报文，没有使用UDP 和 TCP 报文
ping命令发出ICMP 回送请求报文<br>
- traceroute<br>
![](https://upload-images.jianshu.io/upload_images/4714178-c7ac28b767322ac5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![使用ICMP 报文组装成IP报文](https://upload-images.jianshu.io/upload_images/4714178-2ec4f79301d4467d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 因特网路由选择协议
### 分层次的路由选择协议
- 域间路由选择<br>
自治系统之间的路由选择
- 域内路由选择<br>
内部的路由选择
- IGP 内部网关协议<br>
在一个自制系统内内部使用的路由选择协议 <br>
RIP OSPF
- EGP 外部网关协议<br>
源主机和目的主机处在不同系统中，两个自制系统使用不同的协议，需要使用一种协议将路由选择信息传递到另一个自治系统中， BGP4


### 内部网关协议 RIP
routing information protocol<br>
适用于支持小型的互联网
- 工作原理
1. 基于距离向量的路由选择协议，寻找到最短的距离
2. 只能找到”距离最短“的路由 哪怕还存在另外一条高速但是低时延的路由
3. 不能在两条网络中使用多条路由

- RIP的特点
    - 仅仅和相邻的路由器交换信息
    - 交换的信息是本路由器知道的全部信息
    - 按照固定的时间间隔更新路由表

![RIP协议距离的规定](https://upload-images.jianshu.io/upload_images/4714178-a2f382058bab4563.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

注：RIP 定期交换消息，RIP在路由表中可以存储到某一个网络的``<网络IP，下一跳>``键值对<br>
RIP协议使用运输层的用户数据报UDP进行传送

- RIP协议的问题
    - 路由回环<br>
- 解决策略<br>
制定最大跳数为16防止路由回环
- 水平分割<br>
不向邻居发送接收到的路由表项<br>
设置反向距离为最大

- RIP协议优缺点
- 优点
    - 简单 容易实现
- 缺点
    - 度量值以16位界
    - 安全性差
    - 收敛缓慢
    - 占用带宽大


### 内部网关协议 OSPF 开放最短路径优先
- OSPF 应用场景
- OSPF 如何工作
（链路状态协议）
![](https://upload-images.jianshu.io/upload_images/4714178-be7469dc48cbe719.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- OSPF 协议的特点   
    - 使用泛洪发发送信息<br>
    每个节点向自治系统中的其他所有节点发送LSP，这样所有的路由器都能获得这个信息的副本
    - 发送的信息是相邻的路由器的链路状态
    - 只有链路发生变化时才会 泛洪法发送信息
    - 知道全网的拓扑结构
- OSPF 收敛速度快
- OSPF 划分区域
    - 主干区域：上层区域
    - 区域：下层区域
    ![](https://upload-images.jianshu.io/upload_images/4714178-6015e8c30871ef71.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
    主干路由器也可以是区域边界路由器，同时也是使用IP数据报传递消息
- OSPF的特点
    - 管理员指派代价，灵活性高于RIP
    - 通信量分配给相同代价的路径，实现负载均衡
    - 鉴别分组，仅可在可信赖的路由器之间更新
    - OSPF支持可变长度子网划分 和 无分类编址
    - 链路状态不会重复
- OSPF 数据报格式
    - 版本
    - 类型：五种类型一种
    - 分组长度
    包括首部在内的分组长度，字节单位
    - 路由器标识符
    发送这个分组的路由器的IP地址
    - 区域标识符
    - 检验和
    检测分组中的差错
    - 检验类型
    - 鉴别

### RIP OSPF区别
- 异
    - 更新时机<br>
    - 收敛速度<br>
    - 交换信息的算法不同<br>
    - 交换的信息不相同
    - 适应的内容不相同
- 同
    - 都是内部网关协议

## 路由算法

## 外部网关协议 BGP
- BGP出现的原因
    1. 互联网的路由器较多，如果使用RIP，路由器将会交换和保存过多信息
    2. AS之间使用的是不同的协议决定AS的：“代价”
    3. 使用了``路径向量`` 
    需要找到一条在源AS和目的AS之间的道路，路径向量路由选择协议
- 什么是路径向量<br>
一种通过列举的方式建立从一个AS到另外一个AS的方法。
- BGP 发言人
自治系统的管理员至少选择一个路由器作为该自治系统的BGP发言人。边界路由器不一定是发言人，发言人一定是边界路由器。BGP发言人通过本地的策略选择一条到达某个地方的路由。
![BGP发言人和AS的关系](https://upload-images.jianshu.io/upload_images/4714178-40ea85aca1bed92e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- BGP可以通过AS号防止闭环   《系统方法》P168
- BGP的工作方式
    1. 管理员规定一个BGP发言人
    2. 建立TCP链接，在TCP链接上交换BGP报文
- BGP的结果<br>
找到一条比较好,不兜圈子的路由 而不一定是最佳的

## IP多播
- IP多播是什么<br>
一个主机向多个节点发送消息,不需要通过单播产生过多的副本<br>
![单播和多播的区别](https://upload-images.jianshu.io/upload_images/4714178-eaa7c2ce91068909.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- 多播地址<br>
多播地址就是使用D类地址作为目的地址（标识符），IP数据报首部的协议字段是2，表明管理网际组管理协议IGMP<br>
多播内容发送到多播组成员中，IGMP协议的目的是让连接在本地局域网内上的多播路由器知道本局域网上是否有主机的进程是否参加或者退出了某个多播组。
- 多播如何工作
    - 发送的数据报中写入多播组的标识符<br>
    使加入多播组的IP地址和标识符相互关联
- 多播的种类
    - 局域网范围内使用硬件多播
    - 互联网范围内多播
### 多播协议

### IGMP
- 什么是IGMP
让互联网上的多播路由器知道有哪些主机的进程加入了或者退出了多播组
    - 传送方式<br>
    IP数据报
- IGMP 工作方式
    - 第一阶段
        1. 新的主机加入多播组，发IGMP报文，声明成为这个多播组的成员
        2. 多播路由器发送这个新的组间关系给其他路由器
    - 第二阶段
        1. 本地多播路由器周期性询问主机是否还是组的成员，如果这个组没有人响应，路由器不会再将这个组的消息转发给其他人
- IGMP 协议还使用了很多详细的设定 避免网络中过多的流量

###  多播路由协议
局域网上多播路由器和互联网上的多播路由器合作，是多播数据报以最小的代价传送给所有组成的成员。<br>
- 多播组的特点<br>
    - 多播组需要动态得适应多播组成员的变化
![动态适应](https://upload-images.jianshu.io/upload_images/4714178-fc798651f6e1405e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
如果G主机加入了多播组，原本不会向N3网络发送数据的R，需要转发数据。


## IPv6
- 地址进行无类路由
- IPv6仍然支持无链接的传送
- 地址32位变成128位
- 扩展的地址层次结构
- 灵活的首部格式
    - 首部长度固定为40字节 基本首部
    - 取消了首部检验和字段
    - 基本首部后面可以有一些扩展首部
    - 扩展首部和数据字段合起来成为有效载荷
- 改进的选项
- 允许协议继续扩充
- 支持即插即用
- 支持资源的预分配

## IPv4 IPv6的区别
- 扩展了路由和寻址的能力
- 报头格式的简化
- 对可选项更大的支持
- QoS的功能
- 身份认证和保密
- 加强了移动设备支持
- IPSec的支持
### IPV6的 数据格式
- 首部格式
![IPv6首部字段](https://upload-images.jianshu.io/upload_images/4714178-aba6828771d2add3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- 数据格式
![IPv6数据格式](https://upload-images.jianshu.io/upload_images/4714178-c3a2ea79009a7ddd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- 通信量类
区分不同的IPv6数据报的类别或者优先级
- 流标号
特定源点到特定终点的一系列数据报，同一个流的数据报都具有同样的流标号。
- 有效载荷长度
除基本首部之外的字节数
- 下一个首部
- 跳数限制
路由器转发数据报时将跳数限制字段中的值减去一，跳数限制的值为0的时候丢弃。
- 目的地址

### IPv6的分片
分片交给源站完成

### IPv6地址的记法
- 冒号16进制记法
每个16位的值用十六进制的值表示<br>
    - 零压缩
    FF05：0：0：0：0：0：0：B3 可以写成 FF05：：B3
    - 点分十进制记法的后缀
    0：0：0：0：0：0128.10.2.1
    - CIDR 斜线表示法仍然可用

### IPv6 和 IPv4 如何过渡和兼容
- 兼容IPv4的IPv6地址
    - 将32位的IPv4钱加0扩展到128位
- 映射IPv4的IPv6地址
    - 将32位的IPv4前加两个字节的1，在加0至128位
- 过渡策略
双协议栈<br>
隧道技术<br>

## VPN 和 网络地址转换NAT
- 专用地址
专用地址因为在全世界很多的专用网内部是重复的的，所以也可以称作 可重用地址。<br>
专用地址的出现是用来解决内部网络分配的IP地址（非全球唯一）和互联网上全球唯一的地址重复的问题。<br>
专用地址只能用作本地地址，路由器一律不进行转发
- 虚拟专用网
![使用隧道技术构成虚拟专用网](https://upload-images.jianshu.io/upload_images/4714178-3c7137028bd5fb05.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- 虚拟专用网如何工作    
    - 如果是网络A或者网络B中的数据<br>
    不需要加密，直接在内部网络之间传送
    - 如果是网络A到网络B的数据<br>
    需要给发送到B的数据报的外部加上一个首部，这个首部中包含了场所B的地址，并且加密，路由器2收到后进行解密。在逻辑上看R1和R2好像是一条直通的线路。

### 网络地址转换
- 什么是NAT<br>
专用网中的主机又想和互联网上的主机通信。
- NAT 路由器<br>
需要拥有一个NAT路由器，这个路由器至少有一个全球地址，这个路由器上安装有特定的NAT软件，将专用网络上的IP地址转换为全球的IP地址。<br>
NAT具有全球n个IP地址，还可以加上端口号，使多个内部地址共用一个IP地址。
![共用IP地址](https://upload-images.jianshu.io/upload_images/4714178-3ef935878af63fbc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## ATM 网络
- 什么是ATM网络<br>
异步传输模式的缩写
    - 以信元为基础的，虚连接交换 一种分组交换和复用技术
    -  面向连接，高传输速率且支持多种类型
    - 异步时分复用的方式 通过信息的首部和标头区分不同信道

## 最大前缀匹配

## MPLS协议
- 什么是MPLS协议<br>
依靠IP地址和IP协议，同时MPLS路由器通过通过检查短的，笃定长度的标记了的分组，在链路层使用硬件进行转发，解决路由器中过大的路由表的问题
- MPLS的特点：
    - 支持面向连接的服务质量
    - 支持流量工程 平衡网络负载
    - 有效地支持虚拟专用网 VPN
    - 提高性能
- LSR 标记交换路由器<br>
是一种支持标记交换和路由选择的路由器
- MPLS 域<br>
MPLS域中有很多路由器，这些路由器都是支持标记交换的路由器
- MPLS 工作流程
![MPLS工作流程](https://upload-images.jianshu.io/upload_images/4714178-f9f3bdad67f9f8eb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

1. 对于进入MPLS 域的数据报打上标记
2. 对于打上标记的数据报好会由通过标记进行硬件转发
3. MPLS 层可以使用多种协议进行转发 如 PPP ATM 帧中继等

### 移动IP
- 什么是移动IP<br>
移动IP能够让移动设备用户从一个网络系统中，到另外一个网络系统但是设备的IP地址保持不变，不中断网络通信以及不中断正在执行的网路应用请求，这个能够使得移动节点在移动中保持连接。
- 为什么在网络层支持移动性<br>
    - Internet每一个节点都有网络层
    - 网络层负责将分组路由到合适的位置
    - 移动性面向整个Internet，改变物理介质对应用透明
    - 对全部应用来说是全局解决方案
- 移动IP如何工作<br>
    - 移动IP节点用用两种IP地址： 归属地址和转交地址
    1. 终端在外地网络注册 
    2. 外地网络通知本地代理这个终端的位置，终端代理再请求服务
    3. 主机向本地代理发送分组
    3. 本地代理通过隧道发给，外地代理传给终端